<!DOCTYPE html>
<html lang="en"></html>

<head>
    <meta charset="UTF-8">
    <title>Sliding Gate Animation</title>
    <style>
        body {
            height: 100vh;
            background: #f5f5f5;
            font-family: sans-serif;
            user-select: none;
        }

        .scene {
            position: relative;
            width: 1000px;
            height: 350px;
            border: 5px solid #333;
            background: linear-gradient(to right, #e0e0e0 0%, #e0e0e0 45%, #a0a0a0 45%, #a0a0a0 100%);
            overflow: hidden;
        }

        .scene.dragging {
            cursor: grabbing;
        }

        .gate {
            position: absolute;
            bottom: 20px;
            width: 520px;
            height: 240px;
            background: #bba;
            border: 2px solid #1e3a5f;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 10px;
            z-index: 2;
            box-shadow: #000 0px 4px 8px;

        }

        .handle {
            cursor: grab;
            position: absolute;
            top: 10px;
            left: 10px;
            width: 25px;
            height: 80px;
            background: #777;
            border: 2px solid #000;
            border-radius: 10px;
        }

        .magnet-stack {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            justify-content: space-between;
            height: 120px;
            align-self: flex-end;
            margin: 10px;
            pointer-events: none;
        }

        .bit {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background-color: #777;
            border: 2px solid #000;
            margin: 2px 0;
            display: inline-block; 
        }

        .bit.one {
            background-color: #aaa;
            border: 2px solid #000;
        }

        .bit.dir-a {
            transform: translateX(7px);
        }

        .bit.dir-b {
            transform: translateX(-7px);
        }

        .bit.pos-1 {
            transform: translateX(2px);
        }

        .bit.pos-4 {
            transform: translateX(-2px);
        }

        .sensors {
            position: absolute;
            bottom: 30px;
            width: 100%;
            height: 120px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            z-index: 3;
        }

        .sensor-stack {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            height: 100%;
            margin-top: 0;
        }

        .sensor-stack-example {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            gap: 3px;
            margin-top: 0;
        }

        .sensor {
            width: 18px;
            height: 18px;
            background: darkgreen;
            border-radius: 4px;
            border: 2px solid #000;
            transition: background 0.2s;
            text-align: center;
            color: darkgreen;
            display: inline-block; 
        }

        .sensor.active {
            background: limegreen;
            color: black
        }

        .status-box {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
            z-index: 4;
        }

        .box {
            width: 60px;
            height: 40px;
            background: white;
            border: 2px solid #333;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 18px;
            border-radius: 4px;
            box-shadow: #000 0px 4px 8px;
        }
    </style>
</head>

<body>
    <div style="text-align: center; margin-bottom: 20px;"></div>
        <h2>Sliding Gate with Hall Sensors</h2>
        <p>
            This is an interactive demonstration of how magnets and hall sensors
            can be used to determine a sliding gate's position and direction.
        </p>
        <p>
            Drag the handle to slide the gate left or right. The sensors will
            detect the position and direction based on the magnet patterns.
        </p>
        <p>
            There are two hall sensors for direction detection
            (<span class="sensor active">a</span>, <span class="sensor active">b</span>) and three hall sensors for position detection
            (<span class="sensor active">1</span>, <span class="sensor active">2</span>, <span class="sensor active">4</span>).
            The position sensors represent a 3-bit binary number, where
            <span class="sensor active">1</span> is the least significant bit (LSB)
            and <span class="sensor active">4</span> is the most significant bit (MSB).
        </p>
        <p>
            The magnets are placed along the gate's path in groups of up to
            five magnets. The uppermost and lowermost magnets are always present
            (<span class="bit one"></span>), while the three magnets in between can be either absent
            (<span class="bit nul"></span>) or present (<span class="bit one"></span>).
        </p>
        <p>
            The uppermost magnet (detected by direction sensor <span class="sensor active">a</span>)
            is placed a little bit to the right, the lowermost magnet
            (detected by direction sensor <span class="sensor active">b</span>)
            is placed a little bit to the left. The three magnets in between
            (detected by position sensors <span class="sensor active">1</span>,<span class="sensor active">2</span>,<span class="sensor active">4</span>)
            are aligned vertically centered.
        </p>
        <p>
            If the gate is moving the direction sensors 
            (<span class="sensor active">a</span>,<span class="sensor active">b</span>)
            will be activated in the following order:
            <div style="display: flex; justify-content: left; gap: 10px; margin-top: 10px;">
                ←
                <div class="sensor-stack-example">
                    <span class="sensor">a</span>
                    <span class="sensor">b</span>
                </div>
                <div class="sensor-stack-example">
                    <span class="sensor">a</span>
                    <span class="sensor active">b</span>
                </div>
                <div class="sensor-stack-example">
                    <span class="sensor active">a</span>
                    <span class="sensor active">b</span>
                </div>
                <div class="sensor-stack-example">
                    <span class="sensor active">a</span>
                    <span class="sensor">b</span>
                </div>
                <div class="sensor-stack-example">
                    <span class="sensor">a</span>
                    <span class="sensor">b</span>
                </div>
                →
                <div class="sensor-stack-example">
                    <span class="sensor">a</span>
                    <span class="sensor">b</span>
                </div>
                <div class="sensor-stack-example">
                    <span class="sensor active">a</span>
                    <span class="sensor">b</span>
                </div>
                <div class="sensor-stack-example">
                    <span class="sensor active">a</span>
                    <span class="sensor active">b</span>
                </div>
                <div class="sensor-stack-example">
                    <span class="sensor">a</span>
                    <span class="sensor active">b</span>
                </div>
                <div class="sensor-stack-example">
                    <span class="sensor">a</span>
                    <span class="sensor">b</span>
                </div>
            </div>
        </p>
        <p>
            If the sensors <span class="sensor active">a</span>,<span class="sensor active">b</span>
            are both active, the hall sensor over the center of a magnet group.
            Only at this position, the position sensors 
            (<span class="sensor active">1</span>,<span class="sensor active">2</span>,<span class="sensor active">4</span>)
            will report a correct position.
        </p>
        <p>
            The direction is determined by the top and bottom sensors only.
            The direction changes when the top and bottom sensors change their
            state and have different states, but had the same state before.
            This way the direction can be determined even when the position
            is not correct.
        </p>
    </div>
    <div class="scene" id="scene">
        <div class="gate" id="gate">
            <div class="handle" id="handle"></div>
            <div class="magnet-stack">
                <div class="bit one dir-a"></div>
                <div class="bit nul pos-4"></div>
                <div class="bit nul pos-2"></div>
                <div class="bit nul pos-1"></div>
                <div class="bit one dir-b"></div>
            </div>
            <div class="magnet-stack">
                <div class="bit one dir-a"></div>
                <div class="bit nul pos-4"></div>
                <div class="bit nul pos-2"></div>
                <div class="bit one pos-1"></div>
                <div class="bit one dir-b"></div>
            </div>
            <div class="magnet-stack">
                <div class="bit one dir-a"></div>
                <div class="bit nul pos-4"></div>
                <div class="bit one pos-2"></div>
                <div class="bit nul pos-1"></div>
                <div class="bit one dir-b"></div>
            </div>
            <div class="magnet-stack">
                <div class="bit one dir-a"></div>
                <div class="bit nul pos-4"></div>
                <div class="bit one pos-2"></div>
                <div class="bit one pos-1"></div>
                <div class="bit one dir-b"></div>
            </div>
            <div class="magnet-stack">
                <div class="bit one dir-a"></div>
                <div class="bit one pos-4"></div>
                <div class="bit nul pos-2"></div>
                <div class="bit nul pos-1"></div>
                <div class="bit one dir-b"></div>
            </div>
            <div class="magnet-stack">
                <div class="bit one dir-a"></div>
                <div class="bit one pos-4"></div>
                <div class="bit nul pos-2"></div>
                <div class="bit one pos-1"></div>
                <div class="bit one dir-b"></div>
            </div>
            <div class="magnet-stack">
                <div class="bit one dir-a"></div>
                <div class="bit one pos-4"></div>
                <div class="bit one pos-2"></div>
                <div class="bit nul pos-1"></div>
                <div class="bit one dir-b"></div>
            </div>
            <div class="magnet-stack">
                <div class="bit one dir-a"></div>
                <div class="bit one pos-4"></div>
                <div class="bit one pos-2"></div>
                <div class="bit one pos-1"></div>
                <div class="bit one dir-b"></div>
            </div>
        </div>

        <div class="sensors" id="sensors">
            <div class="sensor-stack">
                <div class="sensor" id="hall-sensor-a">a</div>
                <div class="sensor" id="hall-sensor-4">4</div>
                <div class="sensor" id="hall-sensor-2">2</div>
                <div class="sensor" id="hall-sensor-1">1</div>
                <div class="sensor" id="hall-sensor-b">b</div>
            </div>
        </div>

        <div class="status-box">
            <div style="display: flex; align-items: center; gap: 2px; height: 80px;">
                <div class="sensor" id="calc-pos-1">1</div>
                <span>+</span>
                <div class="sensor" id="calc-pos-2">2</div>
                <span>+</span>
                <div class="sensor" id="calc-pos-4">4</div>
                <span>=</span>
            </div>
            <div>
                <div>Sensor</div>
                <div class="box" id="position-box" style="color: #aaa;">?</div>
            </div>
            <div>
                <div class="sensor" id="calc-pos-a">a</div><br/>
                <span class="accept-pos" id="accept-pos">→</span><br/>
                <div class="sensor" id="calc-pos-b">b</div>
            </div>
            <div>
                <div>Position</div>
                <div class="box" id="position-box-approved">?</div>
            </div>
            <div>
                <div>Direction</div>
                <div class="box" id="direction-box">→</div>
            </div>
        </div>
    </div>
    <div>
        <p>
            This illustration is not to scale. In reality, the
            magnets are much smaller and the distances between the magnet groups
            are much larger. This illustration serves only for demonstration purposes.
        </p>
        <p>
            In my case a magnet group has a width of 1 cm and the distance
            between two magnet groups is about 50 cm.
        </p>
    </div>

    <script>
        const gate = document.getElementById("gate");
        const handle = document.getElementById("handle");
        const sensors = document.querySelectorAll(".sensor-stack .sensor");
        const scene = document.getElementById("scene");
        const positionBox = document.getElementById("position-box");
        const positionBoxApproved = document.getElementById("position-box-approved");
        const directionBox = document.getElementById("direction-box");

        const sensorDirA = document.getElementById("hall-sensor-a");
        const sensorPos4 = document.getElementById("hall-sensor-4");
        const sensorPos2 = document.getElementById("hall-sensor-2");
        const sensorPos1 = document.getElementById("hall-sensor-1");
        const sensorDirB = document.getElementById("hall-sensor-b");

        const calcPos4 = document.getElementById("calc-pos-4");
        const calcPos2 = document.getElementById("calc-pos-2");
        const calcPos1 = document.getElementById("calc-pos-1");
        const calcPosA = document.getElementById("calc-pos-a");
        const calcPosB = document.getElementById("calc-pos-b");

        let dragging = false;
        let offsetX = 0;
        let lastX = 0;

        let previousDirA = false;
        let previousDirB = false;

        handle.addEventListener('mousedown', e => {
            dragging = true;
            offsetX = e.clientX - gate.offsetLeft;
            lastX = e.clientX;
            scene.classList.add('dragging');
        });

        window.addEventListener('mouseup', () => {
            dragging = false;
            scene.classList.remove('dragging');
        });

        window.addEventListener('mousemove', e => {
            if (dragging) {
                let newLeft = e.clientX - offsetX;
                newLeft = Math.max(0, Math.min(scene.clientWidth - gate.clientWidth - 5, newLeft));

                const currentLeft = parseInt(gate.style.left) || 0;
                const targetLeft = newLeft;
                const step = currentLeft < targetLeft ? 1 : -1;
                
                for (let pos = currentLeft; pos !== targetLeft; pos += step) {
                    gate.style.left = pos + 'px';
                    updateSensors();
                }
                gate.style.left = targetLeft + 'px';

            }
            updateSensors();
        });

        updateSensors()

        function setSensorState(sensor, isActive) {
            if (isActive) {
                sensor.classList.add("active");
            } else {
                sensor.classList.remove("active");
            }
        }

        function updateSensors() {
            const bits = gate.querySelectorAll(".bit.one");
            sensors.forEach(sensor => sensor.classList.remove("active"));
            bits.forEach(bit => {
                const bRect = bit.getBoundingClientRect();
                sensors.forEach(sensor => {
                    const sRect = sensor.getBoundingClientRect();
                    if (!(bRect.right < sRect.left || bRect.left > sRect.right || bRect.bottom < sRect.top || bRect.top > sRect.bottom)) {
                        sensor.classList.add("active");
                    }
                });
            });

            dirA = sensorDirA.classList.contains("active");
            dirB = sensorDirB.classList.contains("active");
            pos1 = sensorPos1.classList.contains("active") ? 1 : 0;
            pos2 = sensorPos2.classList.contains("active") ? 2 : 0;
            pos4 = sensorPos4.classList.contains("active") ? 4 : 0;

            position = pos1 + pos2 + pos4
            setSensorState(calcPos1, pos1);
            setSensorState(calcPos2, pos2);
            setSensorState(calcPos4, pos4);
            setSensorState(calcPosA, dirA);
            setSensorState(calcPosB, dirB);

            // display the detected position
            // (might be wrong if hall sensor is not centered)
            positionBox.textContent = position;

            // only if bottom and top sensors are active the position is valid
            if (dirB && dirA) {
                positionBoxApproved.textContent = position;
            }

            // determine direction.
            //
            // top-sensor    ...00110...00110...00110...
            // bottom-sensor ...01100...01100...01100...
            //
            // check if the bottom or top sensor changed
            if ((dirB != previousDirB) || (dirA != previousDirA)) {
                // we detect a direction change only top and bottom sensor now
                // have different states, but had the same state before
                if ((dirB != dirA) && (previousDirB == previousDirA)) {
                    let dir = dirA;
                    if (previousDirB)
                        dir = !dir;
                    directionBox.textContent = dir ? '→' : '←';
                }
                previousDirB = dirB;
                previousDirA = dirA;
            }
        }

    </script>
</body>

</html>